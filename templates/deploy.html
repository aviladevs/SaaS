{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-rocket"></i> Deploy de Serviços
        </h1>
        <p class="lead">Faça deploy de serviços de forma fácil e segura</p>
    </div>
</div>

<!-- Deploy Rápido -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Deploy Rápido</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success btn-lg w-100 mb-3" onclick="deployService('all')">
                            <i class="fas fa-rocket"></i> Deploy Completo
                            <br><small class="text-white-50">Todos os serviços</small>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-lg w-100 mb-3" onclick="showServiceSelector()">
                            <i class="fas fa-cog"></i> Deploy Específico
                            <br><small class="text-white-50">Escolher serviços</small>
                        </button>
                    </div>
                </div>

                <div id="serviceSelector" style="display: none;">
                    <hr>
                    <h6>Selecione os serviços para deploy:</h6>
                    <div class="row">
                        {% for service_id, service_info in services.items() %}
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="{{ service_id }}" value="{{ service_id }}">
                                <label class="form-check-label" for="{{ service_id }}">
                                    {{ service_info.name }}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="deploySelectedServices()">
                            <i class="fas fa-play"></i> Iniciar Deploy Selecionado
                        </button>
                        <button class="btn btn-secondary" onclick="hideServiceSelector()">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status do Deploy -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Status do Deploy</h5>
            </div>
            <div class="card-body">
                <div id="deployStatus">
                    <div class="text-center text-muted">
                        <i class="fas fa-clock fa-2x mb-3"></i>
                        <p>Aguardando ação do usuário...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Deploys -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Histórico de Deploys</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Serviço</th>
                                <th>Status</th>
                                <th>Duração</th>
                                <th>Usuário</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ "2024-01-15 10:30:00" }}</td>
                                <td>Todos os serviços</td>
                                <td><span class="badge bg-success">Sucesso</span></td>
                                <td>5m 32s</td>
                                <td>admin@aviladevops.com.br</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>{{ "2024-01-14 16:45:00" }}</td>
                                <td>Sistema Fiscal</td>
                                <td><span class="badge bg-success">Sucesso</span></td>
                                <td>2m 15s</td>
                                <td>dev@aviladevops.com.br</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>{{ "2024-01-14 09:20:00" }}</td>
                                <td>Landing Page</td>
                                <td><span class="badge bg-warning">Aviso</span></td>
                                <td>3m 45s</td>
                                <td>admin@aviladevops.com.br</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="deployModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Deploy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja fazer deploy?</p>
                <div id="deployDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmDeploy()">Confirmar Deploy</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedServices = [];

function showServiceSelector() {
    document.getElementById('serviceSelector').style.display = 'block';
}

function hideServiceSelector() {
    document.getElementById('serviceSelector').style.display = 'none';
    // Desmarcar todos os checkboxes
    document.querySelectorAll('#serviceSelector input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function deployService(service) {
    if (service === 'all') {
        deploySelectedServices();
    } else {
        selectedServices = [service];
        showDeployModal(['Deploy do serviço: ' + getServiceName(service)]);
    }
}

function deploySelectedServices() {
    selectedServices = [];
    document.querySelectorAll('#serviceSelector input[type="checkbox"]:checked').forEach(cb => {
        selectedServices.push(cb.value);
    });

    if (selectedServices.length === 0) {
        alert('Selecione pelo menos um serviço!');
        return;
    }

    const serviceNames = selectedServices.map(s => getServiceName(s));
    showDeployModal(['Deploy dos serviços:', ...serviceNames]);
}

function showDeployModal(details) {
    document.getElementById('deployDetails').innerHTML = details.map(d => `<li>${d}</li>`).join('');
    new bootstrap.Modal(document.getElementById('deployModal')).show();
}

function confirmDeploy() {
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('deployModal')).hide();

    // Mostrar progresso
    showDeployProgress();

    // Simular deploy (em produção, fazer chamada para API)
    setTimeout(() => {
        showDeployResult('success', 'Deploy realizado com sucesso!');
    }, 3000);
}

function showDeployProgress() {
    document.getElementById('deployStatus').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Executando deploy...</p>
            <div class="progress mt-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 75%"></div>
            </div>
        </div>
    `;
}

function showDeployResult(status, message) {
    const icon = status === 'success' ? 'check-circle' : 'exclamation-triangle';
    const color = status === 'success' ? 'success' : 'danger';

    document.getElementById('deployStatus').innerHTML = `
        <div class="text-center">
            <i class="fas fa-${icon} fa-3x text-${color} mb-3"></i>
            <p>${message}</p>
            <button class="btn btn-primary" onclick="location.reload()">Voltar ao Dashboard</button>
        </div>
    `;
}

function getServiceName(serviceId) {
    const serviceNames = {
        'landing-page': 'Landing Page',
        'sistema': 'Sistema de Reciclagem',
        'fiscal': 'Sistema Fiscal',
        'clinica': 'Clínica Management',
        'app-aviladevops': 'Admin Dashboard'
    };
    return serviceNames[serviceId] || serviceId;
}
</script>
{% endblock %}
